## 5. 状态流转

### 5.1 状态定义

#### 5.1.1 用户状态
| 状态 | 状态值 | 描述 | 是否终态 | 可逆转性 |
|------|--------|------|----------|----------|
| 匿名 | `anonymous` | 未注册 | ❌ | ✅ 可重试 |
| 已注册 | `registered` | Clerk用户 | ❌ | ✅ 可失败 |
| 已冻结 | `frozen` | 管理员/风控介入 | ❌ | ✅ 可重试 |
| 已注销 | `deleted` | Clerk删除 | ✅ | ❌ 不可逆转 |

#### 5.1.2 订单状态
| 状态 | 状态值 | 描述 | 是否终态 | 可逆转性 |
|------|--------|------|----------|----------|
| 订单创建 | `created` | 订单已创建，等待支付 | ❌ | ✅ 可重试 |
| 支付成功 | `success` | Stripe支付成功 | ❌ | ✅ 可失败 |
| 支付失败 | `failed` | 支付被拒绝/取消/超时 | ❌ | ✅ 可重试 |
| 订单退款 | `refunded` | 订单已退款（部分或全额） | ✅ | ❌ 不可逆转 |
| 订单冻结 | `frozen` | 风控或合规介入冻结 | ❌ | ✅ 可解除 |
| 订单失败 | `failed` | 最终失败状态 | ✅ | ❌ 不可逆转 |

#### 5.1.3 订阅状态
| 状态 | 状态值 | 描述 | 是否终态 | 可逆转性 |
|------|--------|------|----------|----------|
| 匿名初始化 | `incomplete` | 匿名用户 | ❌ | ✅ 可重试 |
| 试用期 | `trialing` | 系统开启功能 | ❌ | ✅ 可变化|
| 活跃 | `active` | 订阅支付 | ❌ | ✅ 可续订 |
| 已过期 | `past_due` | 订阅的到期 | ❌  | ✅ 可逆转 |
| 已取消 | `canceled` | 取消订阅 | ✅ | ❌ 不可逆转 |

### 5.2 用户生命周期状态机图

以下状态机图描述了用户从匿名状态到注册、登录、注销、再注册的生命周期状态转换，涵盖 `Users` 表的状态变化。

```mermaid
stateDiagram-v2
    direction TB
    
    [*] --> Anonymous
    
    Anonymous --> Registering : 选择注册
    Anonymous --> [*] : 离开平台
    
    Registering --> Registered : 提交信息完成注册
    
    Registered --> LoggedIn : 登录成功
    
    LoggedIn --> LoggedIn : 进行操作(订阅/使用)
    LoggedIn --> Anonymous : 登出
    LoggedIn --> Deleting : 发起注销请求
    
    Deleting --> Purge : 执行数据清理
    
    Purge --> Anonymous : 重新访问平台
```

### 5.3 订单状态机

以下状态机表示用户订阅的生命周期，包括用户操作或Stripe Webhook触发的状态转换。

```mermaid
stateDiagram-v2
    direction TB
    
    [*] --> 订单创建: 用户发起支付
    订单创建 --> 支付成功: Stripe支付完成
    订单创建 --> 支付失败: 支付被拒/取消/超时
    支付成功 --> 订单完成: 积分充值成功
        
    state 订单终态 {
       direction TB
       订单完成 --> 退款: 用户申请退款
       订单完成 --> 冻结: 风控介入
       冻结 --> 订单完成: 风控解除
       冻结 --> 订单失败: 人工介入
   }
    
    %% 状态说明
    note right of 订单创建
        订单状态：
        - created: 订单已创建
        - success: 支付成功
        - failed: 支付失败
        - refunded: 订单退款
        - frozen: 订单冻结
        - failed: 订单失败
    end note
    
    note right of 订单终态
        终态特性：
        - 订单完成：不可逆转，可退款
        - 订单失败：不可逆转，可人工重试
        - 订单退款：不可逆转
    end note
```

### 5.4 积分状态机

此状态机表示用户积分余额在使用过程中的状态。

```mermaid
stateDiagram-v2
    direction TB
        [*] --> 余额 : 分配免费/付费积分
        
        余额 --> 检查余额 : 触发消耗
        检查余额 --> 足够 : 余额够
        检查余额 --> 不足 : 余额不够
        
        足够 --> 扣除 : 扣 paid→onetime_paid→free
        扣除 --> 已扣 : 扣除完成
        已扣 --> 足够 : 有剩余
        
        不足 --> 提示 : 提醒购买
        提示 --> 无操作 : 拒绝
        无操作 --> [*] : 结束
        提示 --> 充值 : 购买积分
        充值 --> 余额 : 补充积分
        
```

